{% extends "base.html" %}

{% block title %}
View Graph | Chrome Historian
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="page-header">
                <h1>View Graph for {{ url.url }}</h1>
            </div>

            <div id="cy" style="background-color: gray"></div>
        </div>
    </div>
{% endblock %}

{% block extrajs %}
    <script src="/static/js/cytoscape.min.js"></script>
    <script>
        $(document).ready(function() {
            var cy = cytoscape({
                container: $("#cy"),
                style: cytoscape.stylesheet()
                    .selector('node')
                        .css({
                            'content': 'data(url)',
                            'text-align': 'center',
                            'color': 'white',
                            'text-outline-width': 2,
                            'background-color': '#999',
                            'text-outline-color': '#999'
                        })
                    .selector('edge')
                        .css({
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': '#ccc',
                            'line-cllor': '#ccc',
                            'width': 1
                        })
            });

            $.ajax({
                method: "GET",
                url: "{{ url_for('graph_ajax', id=url.id) }}",
                dataType: 'json',
                success: function(data) {
                    for (var i = 0; i < data.length; i++) {
                        var visit = data[i];

                        cy.add({
                            data: {
                                id: visit.id,
                                url: visit.url,
                                uri_id: visit.url_id,
                                title: visit.title
                            }
                        });
                    }

                    // Make edges
                    for (i = 0; i < data.length; i++) {
                        visit = data[i];
                        if (visit.from != 0) {
                            cy.add({
                                data: {
                                    id: "edge" + visit.id + "-" + visit.from,
                                    source: visit.from,
                                    target: visit.id
                                }
                            });
                        }
                    }

                    cy.layout({ name: 'breadthfirst' });
                }
            });
        })
    </script>
{% endblock %}

{% block extrastyles %}
    <style>
        #cy {
            width: 100%;
            height: 500px;
            display: block;
        }
    </style>
{% endblock %}